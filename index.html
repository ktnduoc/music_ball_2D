<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Ball 2D - Modular</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/src/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>
    <div class="toggle-btn" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </div>

    <div id="timing-toggle-btn" onclick="toggleTiming()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
    </div>

    <div id="timing-ui" class="collapsed">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 18px; margin: 0;">TIMING ENGINE</h1>
            <div style="cursor: pointer; padding: 5px; opacity: 0.6;" onclick="toggleTiming()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
        </div>
        
        <div id="spawner-list">
            <!-- Dynamically filled -->
        </div>

        <button class="btn" style="margin-top: 20px;" onclick="window.runSequence()">â–¶ RUN SEQUENCE (SPACE)</button>
        <div class="tip">SET DELAY IN SECONDS</div>
    </div>

    <div id="ui">
        <h1>MUSIC BALL 2D</h1>
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 20px;">
            <button class="btn btn-secondary" style="flex: 2; margin-bottom: 0;" onclick="window.toggleShapePalette()">SHAPES</button>
            <button id="add-spawner-btn" class="btn btn-secondary" style="flex: 0.5; margin-bottom: 0; padding: 10px;" onclick="window.addSpawner()" title="Add Spawner">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="var(--accent)">
                    <circle cx="12" cy="12" r="8" />
                    <circle cx="9" cy="9" r="2" fill="white" opacity="0.6" />
                </svg>
            </button>
        </div>

        <div id="selection-controls" style="display: none;">
            <div class="control" style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <label>Top Surface Curvature</label>
                <input id="curvature-top" type="range" min="-2.0" max="2.0" step="0.1" value="0" oninput="window.updateBarCurvatureTop(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 8px; opacity: 0.5;">
                    <span>CONCAVE</span>
                    <span>FLAT</span>
                    <span>CONVEX</span>
                </div>
            </div>

            <div class="control">
                <label>Bottom Surface Bulge</label>
                <input id="curvature-bottom" type="range" min="-2.0" max="2.0" step="0.1" value="0" oninput="window.updateBarCurvatureBottom(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 8px; opacity: 0.5;">
                    <span>CONCAVE</span>
                    <span>FLAT</span>
                    <span>CONVEX</span>
                </div>
            </div>

            <div class="control" style="margin-top: 15px; background: rgba(0, 255, 100, 0.05); padding: 10px; border-radius: 8px; border: 1px dashed rgba(0, 255, 100, 0.3);">
                <div class="tip" style="margin: 0; color: #4ade80; font-size: 10px;">TIP: DRAG BORDER TO RESIZE</div>
                <div class="tip" style="margin: 5px 0 0 0; color: #4ade80; font-size: 10px;">TIP: DRAG TOP HANDLE TO ROTATE</div>
            </div>

            <div class="control">
                <label>Bar Shape</label>
                <div style="display: flex; gap: 8px;">
                    <select id="bar-shape" class="btn btn-secondary" style="text-transform: none; margin-bottom: 12px; flex: 1;" onchange="window.updateBarShape(this.value)">
                        <option value="rect">Rectangle (Classic)</option>
                        <option value="circle">Circle (Bumper)</option>
                        <option value="triangle">Triangle (Slope)</option>
                        <option value="wave_bridge">Wave Bridge (Preset)</option>
                        <option value="bowl_slope">Bowl Slope (Preset)</option>
                    </select>
                    <button id="btn-copy-shape" class="btn btn-secondary" style="padding: 0 15px; margin-bottom: 12px; font-size: 10px;" onclick="window.copyShape()" title="Copy Physical Shape Data">COPY SHAPE</button>
                </div>
            </div>

            <div class="control">
                <label>Musical Note</label>
                <select id="bar-note" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateBarNote(this.value)">
                    <option value="Auto">Auto (By Height)</option>
                    <optgroup label="Octave 3">
                        <option value="C3">C3</option><option value="D3">D3</option><option value="E3">E3</option><option value="F3">F3</option>
                        <option value="G3">G3</option><option value="A3">A3</option><option value="B3">B3</option>
                    </optgroup>
                    <optgroup label="Octave 4">
                        <option value="C4">C4</option><option value="D4">D4</option><option value="E4">E4</option><option value="F4">F4</option>
                        <option value="G4">G4</option><option value="A4">A4</option><option value="B4">B4</option>
                    </optgroup>
                    <optgroup label="Octave 5">
                        <option value="C5">C5</option><option value="D5">D5</option><option value="E5">E5</option><option value="F5">F5</option>
                        <option value="G5">G5</option><option value="A5">A5</option><option value="B5">B5</option>
                    </optgroup>
                    <option value="C6">C6 (High)</option>
                </select>
            </div>

            <div class="control" style="margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;">
                <label>Bar Instrument</label>
                <select id="bar-instrument" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateBarInstrument(this.value)">
                    <option value="sine">Clean (Sine)</option>
                    <option value="square">8-Bit (Square)</option>
                    <option value="sawtooth">Saxophone-ish (Sawtooth)</option>
                    <option value="triangle">Soft (Triangle)</option>
                    <option value="bell">Wind Chimes (Bell)</option>
                    <option value="glass">Crystal Glass (Clink)</option>
                    <option value="drum">Orchestral Drum (Heroic)</option>
                </select>
            </div>
        </div>

        <div class="control">
            <label>Default Instrument (For New Bars)</label>
            <select id="instrument-select" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateInstrument(this.value)">
                <option value="sine">Clean (Sine)</option>
                <option value="square">8-Bit (Square)</option>
                <option value="sawtooth">Saxophone-ish (Sawtooth)</option>
                <option value="triangle">Soft (Triangle)</option>
                <option value="bell">Wind Chimes (Bell)</option>
                <option value="glass">Crystal Glass (Clink)</option>
                <option value="drum">Orchestral Drum (Heroic)</option>
            </select>
        </div>

        <div class="control" style="margin-top: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <label>Gravity</label>
            <input id="gravity-slider" type="range" min="0" max="2" step="0.1" value="1" oninput="window.updateGravity(this.value)" onchange="window.autoBalance('gravity', this.value)">
        </div>
        
        <div class="control">
            <label>Bounce</label>
            <input id="bounce-slider" type="range" min="0" max="1.2" step="0.1" value="0.8" oninput="window.updateBounce(this.value)" onchange="window.autoBalance('bounce', this.value)">
        </div>

        <button id="toggle-follow-btn" class="btn btn-secondary" onclick="window.toggleFollow()">TOGGLE CAMERA FOLLOW</button>
        <button class="btn btn-secondary" onclick="window.clearBalls()">CLEAR ALL BALLS</button>
        
        <div class="control" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <label>Save Current Arrangement</label>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1; background: rgba(0, 242, 254, 0.1); border-color: rgba(0, 242, 254, 0.3); color: #00f2fe; margin-bottom: 0;" onclick="window.exportToJSON()">EXPORT</button>
                <button class="btn btn-secondary" style="flex: 1; margin-bottom: 0;" onclick="window.copyToClipboard()">COPY</button>
            </div>
        </div>

        <div class="control">
            <label>Music Templates</label>
            <select class="btn btn-secondary" style="text-transform: none;" onchange="window.loadTemplate(this.value)">
                <option value="">-- Load a Template --</option>
                <option value="/templates/staircase.json">Staircase (Melody)</option>
                <option value="/templates/plinko.json">Plinko (Bumpers)</option>
                <option value="/templates/midi-jam.json">Midi Jam (Draft)</option>
                <option value="/templates/happy-birthday.json">Happy Birthday (Vertical)</option>
                <option value="/templates/happy-birthday-2.json">Mini Game</option>
            </select>
        </div>

        <div class="control" style="margin-top: 10px;">
            <label>Apply Instrument to All</label>
            <select id="bulk-instrument-select" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateAllBarsInstrument(this.value)">
                <option value="sine">Clean (Sine)</option>
                <option value="square">8-Bit (Square)</option>
                <option value="sawtooth">Saxophone-ish (Sawtooth)</option>
                <option value="triangle">Soft (Triangle)</option>
                <option value="bell">Wind Chimes (Bell)</option>
                <option value="glass">Crystal Glass (Clink)</option>
                <option value="drum">Orchestral Drum (Heroic)</option>
            </select>
            <div class="tip" style="margin-top: 5px; font-size: 9px; opacity: 0.4;">OVERWRITES ALL BARS</div>
        </div>
        
    <div id="export-modal" class="modal-overlay">
        <div class="modal">
            <h2>Export Composition</h2>
            <label>Composition Name</label>
            <input type="text" id="export-name" placeholder="Enter name..." value="my-omposition">
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="window.closeExportModal()">Cancel</button>
                <button class="btn" onclick="window.confirmExport()">Export</button>
            </div>
        </div>
    </div>

    <!-- Overlay to block interactions when palette is open -->
    <div id="palette-overlay" onclick="window.toggleShapePalette()"></div>

    <!-- Ghost shape when dragging -->
    <div id="shape-ghost" class="hidden"></div>

    <!-- Shape Palette Panel -->
    <div id="shape-palette" class="collapsed">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <h2 style="font-size: 14px; margin: 0; color: var(--accent);">LIBRARY</h2>
            <div style="cursor: pointer; padding: 5px; opacity: 0.6;" onclick="window.toggleShapePalette()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="white" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
        </div>
        
        <div class="tip" style="margin-bottom: 12px; font-size: 9px;">DRAG SHAPES TO CANVAS</div>
        
        <div id="shape-items-container">
            <!-- Shape items will be generated here -->
        </div>
    </div>

    <div class="tip">DRAG BARS TO COMPOSE MELODIES</div>
    </div>

    <!-- ES Modules Integration -->
    <script type="module" src="/src/js/game.js"></script>


    <script>
        function toggleMenu() {
            const ui = document.getElementById('ui');
            ui.classList.toggle('collapsed');
        }
        function toggleTiming() {
            const timingUi = document.getElementById('timing-ui');
            timingUi.classList.toggle('collapsed');
        }
    </script>
</body>
</html>

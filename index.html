<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Ball 2D - Modular</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/src/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>
    <div class="toggle-btn" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </div>

    <div id="timing-toggle-btn" onclick="toggleTiming()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
    </div>

    <div id="home-btn" onclick="window.openTemplateModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
    </div>

    <div id="timing-ui" class="collapsed">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 18px; margin: 0;">TIMING ENGINE</h1>
            <div style="cursor: pointer; padding: 5px; opacity: 0.6;" onclick="toggleTiming()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
        </div>
        
        <div id="spawner-list">
            <!-- Dynamically filled -->
        </div>

        <button class="btn" style="margin-top: 20px;" onclick="window.runSequence()">â–¶ RUN SEQUENCE (SPACE)</button>
        <div class="tip">SET DELAY IN SECONDS</div>
    </div>

    <div id="ui">
        <div class="title-container">
            <h1>MUSIC BALL 2D</h1>
            <button id="add-spawner-btn" class="btn btn-secondary" style="width: 40px; height: 40px; margin-bottom: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;" onclick="window.addSpawner()" title="Add Spawner">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="var(--accent)">
                    <circle cx="12" cy="12" r="8" />
                    <circle cx="9" cy="9" r="2" fill="white" opacity="0.6" />
                </svg>
            </button>
        </div>
        <div id="shape-section" class="control" style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="window.toggleShapePalette()">
                <label style="margin-bottom: 0; cursor: pointer;">SHAPE LIBRARY</label>
                <svg id="shape-chevron" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--accent)" stroke-width="3" style="transition: transform 0.3s ease;" class="shape-chevron-rotated">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            
            <div id="shape-palette">
                <div class="tip" style="margin-bottom: 12px; font-size: 9px; text-align: left;">DRAG SHAPES TO CANVAS</div>
                <div id="shape-items-container">
                    <!-- Shape items will be generated here -->
                </div>
            </div>
        </div>

        <div id="selection-controls" style="display: none;">
            <div class="control" style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <label>Top Surface Curvature</label>
                <input id="curvature-top" type="range" min="-2.0" max="2.0" step="0.1" value="0" oninput="window.updateBarCurvatureTop(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 8px; opacity: 0.5;">
                    <span>CONCAVE</span>
                    <span>FLAT</span>
                    <span>CONVEX</span>
                </div>
            </div>

            <div class="control">
                <label>Bottom Surface Bulge</label>
                <input id="curvature-bottom" type="range" min="-2.0" max="2.0" step="0.1" value="0" oninput="window.updateBarCurvatureBottom(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 8px; opacity: 0.5;">
                    <span>CONCAVE</span>
                    <span>FLAT</span>
                    <span>CONVEX</span>
                </div>
            </div>

            <div class="control" style="margin-top: 15px; background: rgba(0, 255, 100, 0.05); padding: 10px; border-radius: 8px; border: 1px dashed rgba(0, 255, 100, 0.3);">
                <div class="tip" style="margin: 0; color: #4ade80; font-size: 10px;">TIP: DRAG BORDER TO RESIZE</div>
                <div class="tip" style="margin: 5px 0 0 0; color: #4ade80; font-size: 10px;">TIP: DRAG TOP HANDLE TO ROTATE</div>
            </div>

            <div class="control">
                <label>Bar Shape</label>
                <div style="display: flex; gap: 8px;">
                    <select id="bar-shape" class="btn btn-secondary" style="text-transform: none; margin-bottom: 12px; flex: 1;" onchange="window.updateBarShape(this.value)">
                        <option value="rect">Rectangle (Classic)</option>
                        <option value="circle">Circle (Bumper)</option>
                        <option value="triangle">Triangle (Slope)</option>
                        <option value="wave_bridge">Wave Bridge (Preset)</option>
                        <option value="bowl_slope">Bowl Slope (Preset)</option>
                    </select>
                    <button id="btn-copy-shape" class="btn btn-secondary" style="padding: 0 15px; margin-bottom: 12px; font-size: 10px;" onclick="window.copyShape()" title="Copy Physical Shape Data">COPY SHAPE</button>
                </div>
            </div>

            <div class="control">
                <label>Musical Note</label>
                <select id="bar-note" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateBarNote(this.value)">
                    <option value="Auto">Auto (By Height)</option>
                    <optgroup label="Octave 3">
                        <option value="C3">C3</option><option value="D3">D3</option><option value="E3">E3</option><option value="F3">F3</option>
                        <option value="G3">G3</option><option value="A3">A3</option><option value="B3">B3</option>
                    </optgroup>
                    <optgroup label="Octave 4">
                        <option value="C4">C4</option><option value="D4">D4</option><option value="E4">E4</option><option value="F4">F4</option>
                        <option value="G4">G4</option><option value="A4">A4</option><option value="B4">B4</option>
                    </optgroup>
                    <optgroup label="Octave 5">
                        <option value="C5">C5</option><option value="D5">D5</option><option value="E5">E5</option><option value="F5">F5</option>
                        <option value="G5">G5</option><option value="A5">A5</option><option value="B5">B5</option>
                    </optgroup>
                    <option value="C6">C6 (High)</option>
                </select>
            </div>

            <div class="control">
                <label>Bar Instrument</label>
                <select id="bar-instrument" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateBarInstrument(this.value)">
                    <option value="sine">Clean (Sine)</option>
                    <option value="square">8-Bit (Square)</option>
                    <option value="sawtooth">Saxophone-ish (Sawtooth)</option>
                    <option value="triangle">Soft (Triangle)</option>
                    <option value="bell">Wind Chimes (Bell)</option>
                    <option value="glass">Crystal Glass (Clink)</option>
                    <option value="drum">Orchestral Drum (Heroic)</option>
                </select>
            </div>

            <div class="control" style="margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;">
                <label>Lifespan (Max Hits)</label>
                <select id="bar-max-hits" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateBarMaxHits(this.value)">
                    <option value="0">Infinite (Forever)</option>
                    <option value="1">1 Hit (Vanish)</option>
                    <option value="2">2 Hits</option>
                    <option value="3">3 Hits</option>
                    <option value="5">5 Hits</option>
                    <option value="10">10 Hits</option>
                </select>
                <div class="tip" style="margin-top: 5px; font-size: 9px; opacity: 0.4;">SHAPE VANISHES AFTER X HITS</div>
            </div>
        </div>

        <div class="control">
            <label>Default Instrument (For New Bars)</label>
            <select id="instrument-select" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateInstrument(this.value)">
                <option value="sine">Clean (Sine)</option>
                <option value="square">8-Bit (Square)</option>
                <option value="sawtooth">Saxophone-ish (Sawtooth)</option>
                <option value="triangle">Soft (Triangle)</option>
                <option value="bell">Wind Chimes (Bell)</option>
                <option value="glass">Crystal Glass (Clink)</option>
                <option value="drum">Orchestral Drum (Heroic)</option>
            </select>
        </div>

        <div class="control" style="margin-top: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <label>Gravity</label>
            <input id="gravity-slider" type="range" min="0" max="2" step="0.1" value="1" oninput="window.updateGravity(this.value)" onchange="window.autoBalance('gravity', this.value)">
        </div>
        
        <div class="control">
            <label>Bounce</label>
            <input id="bounce-slider" type="range" min="0" max="1.2" step="0.1" value="0.8" oninput="window.updateBounce(this.value)" onchange="window.autoBalance('bounce', this.value)">
        </div>

        <!-- Scale Multi-Select (Moved here as requested) -->
        <div id="multi-scale-control" class="control" style="padding-top: 15px; margin-top: 15px; border-top: 1px dashed rgba(255,255,255,0.1);">
            <label style="color: var(--accent);">Scale Selected Bars (<span id="selected-count">0</span>)</label>
            <input id="multi-scale-slider" type="range" min="0.5" max="3.0" step="0.1" value="1.0" oninput="window.scaleSelectedBars(this.value)">
            <div style="display: flex; justify-content: space-between; font-size: 8px; opacity: 0.5; margin-top: 5px;">
                <span>50%</span>
                <span id="scale-value" style="color: var(--accent); font-weight: 600;">100%</span>
                <span>300%</span>
            </div>
        </div>

        <button id="toggle-follow-btn" class="btn btn-secondary" onclick="window.toggleFollow()">TOGGLE CAMERA FOLLOW</button>
        <button class="btn btn-danger" onclick="window.clearBalls()">RESTORE ROUND</button>
        
        <div class="control" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <label>Save Current Arrangement</label>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1; background: rgba(0, 242, 254, 0.1); border-color: rgba(0, 242, 254, 0.3); color: #00f2fe; margin-bottom: 0;" onclick="window.exportToJSON()">EXPORT</button>
                <button class="btn btn-secondary" style="flex: 1; margin-bottom: 0;" onclick="window.importFromFile()">IMPORT</button>
                <button class="btn btn-secondary" style="flex: 1; margin-bottom: 0;" onclick="window.copyToClipboard()">COPY</button>
            </div>
        </div>

        <div class="control">
            <label>Music Templates</label>
            <select class="btn btn-secondary" style="text-transform: none;" onchange="window.askLoadTemplate(this.value)">
                <option value="">-- Load a Template --</option>
                <option value="/templates/staircase.json">Staircase (Melody)</option>
                <option value="/templates/plinko.json">Plinko (Bumpers)</option>
                <option value="/templates/midi-jam.json">Midi Jam (Draft)</option>
                <option value="/templates/happy-birthday.json">Happy Birthday (Vertical)</option>
                <option value="/templates/happy-birthday-2.json">Mini Game</option>
            </select>
        </div>

        <div class="control" style="margin-top: 10px;">
            <label>Apply Instrument to All</label>
            <select id="bulk-instrument-select" class="btn btn-secondary" style="text-transform: none;" onchange="window.updateAllBarsInstrument(this.value)">
                <option value="sine">Clean (Sine)</option>
                <option value="square">8-Bit (Square)</option>
                <option value="sawtooth">Saxophone-ish (Sawtooth)</option>
                <option value="triangle">Soft (Triangle)</option>
                <option value="bell">Wind Chimes (Bell)</option>
                <option value="glass">Crystal Glass (Clink)</option>
                <option value="drum">Orchestral Drum (Heroic)</option>
            </select>
            <div class="tip" style="margin-top: 5px; font-size: 9px; opacity: 0.4;">OVERWRITES ALL BARS</div>
        </div>
    </div> <!-- Close #ui -->

    <div id="export-modal" class="modal-overlay">
        <div class="modal">
            <h2>EXPORT TEMPLATE</h2>
            <input type="text" id="export-name" placeholder="Enter template name (e.g., my-melody)" />
            
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; color: rgba(255,255,255,0.8); text-transform: none; letter-spacing: normal;">
                    <input type="checkbox" id="readonly-checkbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); margin: 0; flex-shrink: 0;">
                    <span style="line-height: 18px;">Make this template read-only</span>
                </label>
                <p style="font-size: 11px; opacity: 0.5; margin: 8px 0 0 28px; line-height: 1.4;">
                    Read-only templates can be viewed and played but cannot be edited.
                </p>
            </div>
            
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="window.closeExportModal()">Cancel</button>
                <button class="btn" onclick="window.confirmExport()">Export</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
            <h2 style="color: #ef4444;">UNSAVED CHANGES</h2>
            <p style="font-size: 14px; opacity: 0.8; margin-bottom: 25px; line-height: 1.5; text-align: left;">Changing templates will overwrite your current work. Any unsaved changes will be lost immediately. <b>Are you sure you want to proceed?</b></p>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="window.closeConfirmModal()">Cancel</button>
                <button class="btn" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: rgba(239, 68, 68, 0.5); margin-bottom: 0;" onclick="window.confirmLoadTemplate()">YES, PROCEED</button>
            </div>
        </div>
    </div>

    <div id="template-modal" class="modal-overlay active">
        <div class="modal">
        <h1 style="text-align: left; margin-bottom: 5px; -webkit-text-fill-color: initial; background: none; color: var(--accent);">WELCOME TO MUSIC BALL 2D</h1>
            <p style="font-size: 14px; opacity: 0.6; margin-bottom: 25px;">Select a template to begin or start with a blank canvas.</p>
            
            <div class="template-grid">
                <!-- Blank Canvas -->
                <div class="template-card blank" onclick="window.closeTemplateModal('blank')">
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                    </div>
                    <h3>Blank Canvas</h3>
                    <p>Start from scratch and build your own unique melody.</p>
                </div>

                <!-- Staircase Melody -->
                <div class="template-card" data-template-url="/templates/staircase.json" onclick="window.closeTemplateModal('/templates/staircase.json')">
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 20V10M12 20V4M6 20v-6"></path>
                        </svg>
                    </div>
                    <h3>Staircase Melody</h3>
                    <p>A classic ascending and descending scale experiment.</p>
                </div>

                <!-- Plinko Bumpers -->
                <div class="template-card" data-template-url="/templates/plinko.json" onclick="window.closeTemplateModal('/templates/plinko.json')">
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="9" cy="9" r="1"></circle>
                            <circle cx="15" cy="9" r="1"></circle>
                            <circle cx="6" cy="13" r="1"></circle>
                            <circle cx="12" cy="13" r="1"></circle>
                            <circle cx="18" cy="13" r="1"></circle>
                        </svg>
                    </div>
                    <h3>Plinko Bumpers</h3>
                    <p>Chaotic and fun patterns using circular bumpers.</p>
                </div>

                <!-- Happy Birthday -->
                <div class="template-card" data-template-url="/templates/happy-birthday.json" onclick="window.closeTemplateModal('/templates/happy-birthday.json')">
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h14v10a2 2 0 0 1-2 2H4"></path>
                            <path d="M22 2v20"></path>
                        </svg>
                    </div>
                    <h3>Happy Birthday</h3>
                    <p>The iconic birthday song arranged vertically.</p>
                </div>

                <!-- MIDI Jam -->
                <div class="template-card" data-template-url="/templates/midi-jam.json" onclick="window.closeTemplateModal('/templates/midi-jam.json')">
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18V5l12-2v13"></path>
                            <circle cx="6" cy="18" r="3"></circle>
                            <circle cx="18" cy="16" r="3"></circle>
                        </svg>
                    </div>
                    <h3>MIDI Jam (Draft)</h3>
                    <p>A more complex multi-spawner arrangement.</p>
                </div>

                <!-- Mini Game -->
                <div class="template-card" data-template-url="/templates/happy-birthday-2.json" onclick="window.closeTemplateModal('/templates/happy-birthday-2.json')">
                    <div class="icon-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                    </div>
                    <h3>Mini Game</h3>
                    <p>A specialized arrangement with interactive elements.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ghost shape when dragging -->
    <div id="shape-ghost" class="hidden"></div>


    <!-- ES Modules Integration -->
    <script type="module" src="/src/js/game.js"></script>


    <script>
        function toggleMenu() {
            const ui = document.getElementById('ui');
            ui.classList.toggle('collapsed');
        }
        function toggleTiming() {
            const timingUi = document.getElementById('timing-ui');
            timingUi.classList.toggle('collapsed');
        }
    </script>
</body>
</html>
